<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Converter - Divisi Human Capital</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --primary: #0F4C81;
            --primary-dark: #0A3A63;
            --primary-light: #1565A8;
            --secondary: #00A896;
            --secondary-light: #02C8B0;
            --accent: #F4B942;
            --accent-light: #FFD166;
            --success: #06D6A0;
            --success-dark: #05B384;
            --bg-light: #F0F7FF;
            --bg-card: #FFFFFF;
            --text-dark: #1A365D;
            --text-muted: #64748B;
            --border: #E2E8F0;
            --shadow: rgba(15, 76, 129, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 50%, #062844 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        .header { 
            text-align: center; 
            color: white; 
            margin-bottom: 30px;
            padding: 20px;
        }

        .header-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .header-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 4px 15px rgba(244, 185, 66, 0.4);
        }

        .header h1 { 
            font-size: 2rem; 
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header-subtitle {
            display: inline-block;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-light) 100%);
            padding: 8px 24px;
            border-radius: 30px;
            font-size: 0.95rem;
            font-weight: 600;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(0, 168, 150, 0.3);
        }

        .header p { 
            opacity: 0.9; 
            font-size: 0.95rem; 
            margin-top: 15px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 50px var(--shadow);
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .upload-zone {
            border: 3px dashed var(--border);
            border-radius: 16px;
            padding: 50px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, var(--bg-light) 0%, #E8F4FD 100%);
        }

        .upload-zone:hover, .upload-zone.dragover { 
            border-color: var(--primary); 
            background: linear-gradient(135deg, #E0EFFF 0%, #D0E8FA 100%);
            transform: translateY(-2px);
        }

        .upload-zone.has-file { 
            border-color: var(--success); 
            background: linear-gradient(135deg, #E6FFF6 0%, #D0FBE8 100%);
        }

        .upload-icon { 
            font-size: 56px; 
            margin-bottom: 15px;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
        }

        .upload-zone h3 { 
            color: var(--text-dark); 
            margin-bottom: 8px; 
            font-size: 1.2rem;
        }

        .upload-zone p { color: var(--text-muted); font-size: 0.9rem; }
        .file-input { display: none; }

        .file-info { 
            margin-top: 25px; 
            padding: 20px; 
            background: linear-gradient(135deg, var(--bg-light) 0%, #E8F4FD 100%);
            border-radius: 16px; 
            display: none;
            border: 1px solid var(--border);
        }

        .file-info.show { display: block; }

        .file-info h4 { 
            color: var(--primary); 
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); 
            gap: 15px; 
        }

        .stat-item { 
            background: white; 
            padding: 18px; 
            border-radius: 12px; 
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            transition: transform 0.2s;
        }

        .stat-item:hover {
            transform: translateY(-3px);
        }

        .stat-item .value { 
            font-size: 1.8rem; 
            font-weight: 700; 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-item .label { 
            font-size: 0.8rem; 
            color: var(--text-muted);
            margin-top: 5px;
            font-weight: 500;
        }

        .btn {
            display: inline-flex; 
            align-items: center; 
            gap: 10px;
            padding: 16px 32px; 
            border: none; 
            border-radius: 12px;
            font-size: 1rem; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease;
            margin: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); 
            color: white;
            box-shadow: 0 4px 20px rgba(15, 76, 129, 0.35);
        }

        .btn-primary:hover:not(:disabled) { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 30px rgba(15, 76, 129, 0.45);
        }

        .btn-primary:disabled { 
            opacity: 0.5; 
            cursor: not-allowed;
            transform: none;
        }

        .btn-success { 
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%); 
            color: white;
            box-shadow: 0 4px 20px rgba(6, 214, 160, 0.35);
        }

        .btn-success:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 30px rgba(6, 214, 160, 0.45);
        }

        .actions { margin-top: 30px; text-align: center; }

        .preview-section { 
            margin-top: 30px; 
            display: none; 
        }

        .preview-section.show { display: block; }

        .preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .preview-header h4 { 
            color: var(--primary); 
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .preview-badge {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            color: var(--text-dark);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .table-wrapper { 
            overflow-x: auto; 
            border-radius: 12px; 
            border: 2px solid var(--primary);
            max-height: 500px;
            box-shadow: 0 4px 20px var(--shadow);
        }

        .table-wrapper::-webkit-scrollbar {
            height: 10px;
            width: 10px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: var(--bg-light);
            border-radius: 5px;
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 5px;
        }

        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.75rem; 
        }

        th, td { 
            padding: 10px 8px; 
            text-align: center; 
            border: 1px solid var(--border); 
            white-space: nowrap; 
        }

        th { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; 
            font-weight: 600; 
            position: sticky; 
            top: 0;
            z-index: 10;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.3px;
        }

        tbody tr:nth-child(even) { background: var(--bg-light); }
        tbody tr:hover { background: #E0EFFF; }

        .processing { 
            display: none; 
            text-align: center; 
            padding: 40px; 
        }

        .processing.show { display: block; }

        .spinner {
            width: 60px; 
            height: 60px; 
            border: 5px solid var(--border); 
            border-top-color: var(--primary);
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
            margin: 0 auto 20px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .success-message { 
            display: none; 
            text-align: center; 
            padding: 25px; 
            background: linear-gradient(135deg, #E6FFF6 0%, #D0FBE8 100%);
            border-radius: 16px; 
            margin-top: 25px;
            border: 2px solid var(--success);
        }

        .success-message.show { display: block; }
        .success-message .icon { font-size: 56px; margin-bottom: 15px; }

        .success-message h3 {
            color: var(--success-dark);
            margin-bottom: 8px;
            font-size: 1.3rem;
        }

        .footer { 
            text-align: center; 
            color: rgba(255,255,255,0.8); 
            margin-top: 30px; 
            padding: 20px;
        }

        .footer-brand {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .footer-sub {
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .divider {
            height: 4px;
            background: linear-gradient(90deg, transparent, var(--accent), var(--secondary), var(--primary), transparent);
            border-radius: 2px;
            margin: 20px 0;
        }

        /* Column highlight for important data */
        td.highlight {
            background: #FFF9E6 !important;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-logo">
                <div class="header-icon">üë•</div>
                <h1>Attendance Converter</h1>
            </div>
            <div class="header-subtitle">Divisi Human Capital</div>
            <p>Konversi Data Absensi Detail ‚Üí Summary Report (Format Book1ss - 51 Kolom)</p>
        </div>

        <div class="card">
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">üìÅ</div>
                <h3>Upload File Absensi</h3>
                <p>Drag & drop file Excel (.xls/.xlsx) atau klik untuk browse</p>
                <p style="margin-top: 10px; font-size: 0.8rem; color: #94a3b8;">Format: Export dari sistem attendance (detail harian)</p>
                <input type="file" class="file-input" id="fileInput" accept=".xls,.xlsx,.html">
            </div>

            <div class="file-info" id="fileInfo">
                <h4>üìÑ Informasi File</h4>
                <div class="file-stats">
                    <div class="stat-item">
                        <div class="value" id="totalRows">0</div>
                        <div class="label">Total Records</div>
                    </div>
                    <div class="stat-item">
                        <div class="value" id="totalEmployees">0</div>
                        <div class="label">Karyawan</div>
                    </div>
                    <div class="stat-item">
                        <div class="value" id="dateRange">-</div>
                        <div class="label">Periode</div>
                    </div>
                </div>
            </div>

            <div class="processing" id="processing">
                <div class="spinner"></div>
                <p style="color: var(--text-dark); font-weight: 500;">Sedang memproses data...</p>
            </div>

            <div class="preview-section" id="previewSection">
                <div class="preview-header">
                    <h4>üìã Preview Hasil Konversi</h4>
                    <div class="preview-badge">51 Kolom Lengkap</div>
                </div>
                <div class="table-wrapper">
                    <table id="previewTable"><thead></thead><tbody></tbody></table>
                </div>
                <p style="margin-top: 12px; font-size: 0.85rem; color: var(--text-muted); text-align: center;">
                    üí° Scroll horizontal untuk melihat semua kolom ‚Ä¢ Data ditampilkan lengkap sesuai format Book1ss
                </p>
            </div>

            <div class="success-message" id="successMessage">
                <div class="icon">‚úÖ</div>
                <h3>Konversi Berhasil!</h3>
                <p style="color: var(--text-muted);">File summary dengan format Book1ss (51 kolom) siap didownload</p>
            </div>

            <div class="actions">
                <button class="btn btn-primary" id="convertBtn" disabled>‚öôÔ∏è Convert ke Summary</button>
                <button class="btn btn-success" id="downloadBtn" style="display: none;">üì• Download Excel</button>
            </div>
        </div>

        <div class="footer">
            <div class="footer-brand">üë• Divisi Human Capital - Bank Sulselbar</div>
            <div class="footer-sub">¬© 2025 | Attendance Management System</div>
        </div>
    </div>

    <script>
        let rawData = null;
        let summaryData = null;

        // 51 Header PERSIS seperti Book1ss.xlsx (termasuk duplikat)
        const COLUMN_HEADERS = [
            'No', 'Employee Code', 'Employee Name', 'Position Code', 'Position Name', 'Organization Unit',
            'Alpha', 'No In', 'No Out', 'Izin', 'Sakit', 'Leave', 'Training', 'Meeting', 'Travel',
            'Cuti Tahunan', 'Cuti Melahirkan', 'Cuti Umroh', 'Cuti Haji', 'Unpaid Leave',
            'Cuti Besar (Normative)', 'Cuti Ekstra 2 Hari', 'Cuti Ekstra 3 Hari', 'Cuti Besar (Conditional)',
            'Izin Khusus', 'Cuti Sakit', 'Absen', 'Hadir', 'Lembur Hari Biasa', 'Lembur Hari Libur',
            'Sakit', 'Izin', 'Leave', 'Libur', 'Lembur', 'Clock In (Jam Masuk)', 'Clock Out (Jam Keluar)',
            'Travel', 'Late In', 'Training', 'Sakit (dg Surat Keterangan Dokter)', 'Fast Out',
            'Work From HOME', 'Izin Khusus (Penugasan Dari Kantor)', 'Meeting', 'Sakit Opname',
            'Training Online', 'Surat Keterangan Jalan', 'Present Not Late', 'Late In (number)', 'Late In (hours)'
        ];

        // Internal unique keys untuk data processing (menghindari konflik duplikat)
        const DATA_KEYS = [
            'no', 'empCode', 'empName', 'posCode', 'posName', 'orgUnit',
            'alpha', 'noIn', 'noOut', 'izin1', 'sakit1', 'leave1', 'training1', 'meeting1', 'travel1',
            'cutiTahunan', 'cutiMelahirkan', 'cutiUmroh', 'cutiHaji', 'unpaidLeave',
            'cutiBesarNorm', 'cutiEkstra2', 'cutiEkstra3', 'cutiBesarCond',
            'izinKhusus', 'cutiSakit', 'absen', 'hadir', 'lemburBiasa', 'lemburLibur',
            'sakit2', 'izin2', 'leave2', 'libur', 'lembur', 'clockIn', 'clockOut',
            'travel2', 'lateIn', 'training2', 'sakitSKD', 'fastOut',
            'wfh', 'izinKhususPenugasan', 'meeting2', 'sakitOpname',
            'trainingOnline', 'suratKeteranganJalan', 'presentNotLate', 'lateInNumber', 'lateInHours'
        ];

        // Column widths
        const COLUMN_WIDTHS = [
            4, 15, 35.4, 13.4, 36.6, 13,
            6.1, 5.7, 7, 5, 6, 6, 8, 8, 6,
            11, 13, 10, 9, 12,
            17, 14, 14, 18,
            10, 9, 6, 6, 15, 14,
            6, 5, 6, 6, 7, 17, 18,
            6, 7, 8, 28, 8,
            14, 30, 8, 11,
            13, 18, 13, 13, 12
        ];

        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const convertBtn = document.getElementById('convertBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const processing = document.getElementById('processing');
        const previewSection = document.getElementById('previewSection');
        const successMessage = document.getElementById('successMessage');

        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault(); uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0]); });

        function getField(row, fieldNames) {
            for (const name of fieldNames) {
                if (row[name] !== undefined && row[name] !== '') return row[name];
            }
            return '';
        }

        function parseHours(str) {
            if (!str) return 0;
            const match = str.toString().match(/(\d+):(\d+)/);
            if (match) return parseInt(match[1]) + parseInt(match[2]) / 60;
            return 0;
        }

        async function handleFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let workbook;
                    const content = e.target.result;
                    const textContent = new TextDecoder().decode(new Uint8Array(content.slice(0, 1000)));
                    const isHTML = textContent.includes('<html') || textContent.includes('<table') || textContent.includes('<!DOCTYPE');
                    
                    if (isHTML) {
                        const fullText = new TextDecoder().decode(new Uint8Array(content));
                        workbook = XLSX.read(fullText, { type: 'string', cellDates: true });
                    } else {
                        workbook = XLSX.read(new Uint8Array(content), { type: 'array', cellDates: true });
                    }
                    
                    rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { defval: '' });
                    if (rawData.length === 0) { alert('File tidak memiliki data!'); return; }
                    
                    uploadZone.classList.add('has-file');
                    uploadZone.innerHTML = `<div class="upload-icon">‚úÖ</div><h3>${file.name}</h3><p>File berhasil dimuat - ${rawData.length} records</p>`;

                    const employees = [...new Set(rawData.map(r => getField(r, ['Employee Code'])).filter(e => e))];
                    const dates = rawData.map(r => getField(r, ['Date'])).filter(d => d);
                    
                    document.getElementById('totalRows').textContent = rawData.length;
                    document.getElementById('totalEmployees').textContent = employees.length;
                    document.getElementById('dateRange').textContent = dates.length > 0 ? dates[0].toString().substring(0, 11) : '-';

                    fileInfo.classList.add('show');
                    convertBtn.disabled = false;
                    previewSection.classList.remove('show');
                    successMessage.classList.remove('show');
                    downloadBtn.style.display = 'none';
                } catch (err) { alert('Error: ' + err.message); console.error(err); }
            };
            reader.readAsArrayBuffer(file);
        }

        convertBtn.addEventListener('click', () => {
            processing.classList.add('show');
            convertBtn.disabled = true;
            setTimeout(() => {
                try {
                    summaryData = convertToSummary(rawData);
                    renderPreview(summaryData);
                    processing.classList.remove('show');
                    previewSection.classList.add('show');
                    successMessage.classList.add('show');
                    downloadBtn.style.display = 'inline-flex';
                    convertBtn.disabled = false;
                } catch (err) { alert('Error: ' + err.message); processing.classList.remove('show'); convertBtn.disabled = false; }
            }, 300);
        });

        function convertToSummary(data) {
            const grouped = {};

            data.forEach(row => {
                const empCode = getField(row, ['Employee Code']);
                if (!empCode) return;

                if (!grouped[empCode]) {
                    // Initialize dengan semua key = 0
                    grouped[empCode] = {};
                    DATA_KEYS.forEach(key => grouped[empCode][key] = 0);
                    
                    // Set employee info
                    grouped[empCode]['empCode'] = empCode;
                    grouped[empCode]['empName'] = getField(row, ['Employee Name']);
                    grouped[empCode]['posCode'] = getField(row, ['Position Code']);
                    grouped[empCode]['posName'] = getField(row, ['Position Name']);
                    grouped[empCode]['orgUnit'] = getField(row, ['Organization Unit Name']);
                }

                const emp = grouped[empCode];
                const code = getField(row, ['Attendance Code']);
                const isHoliday = getField(row, ['Is Holiday']) == 1;
                const timeIn = getField(row, ['Time In']);
                const timeOut = getField(row, ['Time Out']);

                // Map attendance codes ke kedua set kolom
                switch(code) {
                    case 'H': 
                        emp['hadir']++; 
                        break;
                    case 'A': 
                        emp['alpha']++; 
                        emp['absen']++; 
                        break;
                    case 'S': 
                        emp['sakit1']++;  // Kolom K (11)
                        emp['sakit2']++;  // Kolom AE (31)
                        break;
                    case 'I': 
                        emp['izin1']++;   // Kolom J (10)
                        emp['izin2']++;   // Kolom AF (32)
                        break;
                    case 'C': case 'CT': 
                        emp['leave1']++;  // Kolom L (12)
                        emp['leave2']++;  // Kolom AG (33)
                        break;
                    case 'LIBUR': 
                        emp['libur']++; 
                        break;
                    case 'T': case 'TR': 
                        emp['travel1']++; // Kolom O (15)
                        emp['travel2']++; // Kolom AL (38)
                        break;
                    case 'TRN': 
                        emp['training1']++; // Kolom M (13)
                        emp['training2']++; // Kolom AN (40)
                        break;
                    case 'M': case 'MTG': 
                        emp['meeting1']++; // Kolom N (14)
                        emp['meeting2']++; // Kolom AS (45)
                        break;
                }

                // No In/Out - hanya pada hari kerja dengan status Hadir
                if (!isHoliday && code !== 'LIBUR' && code === 'H') {
                    if (!timeIn) emp['noIn']++;
                    if (!timeOut) emp['noOut']++;
                }

                // Clock counts
                if (timeIn) emp['clockIn']++;
                if (timeOut) emp['clockOut']++;

                // Late In
                const lateIn = parseHours(getField(row, ['Late In']));
                if (lateIn > 0) { 
                    emp['lateIn']++; 
                    emp['lateInNumber']++; 
                    emp['lateInHours'] += lateIn; 
                }

                // Present Not Late
                if (code === 'H' && lateIn === 0 && timeIn) emp['presentNotLate']++;

                // Fast Out
                if (parseHours(getField(row, ['Fast Out'])) > 0) emp['fastOut']++;

                // Overtime
                const overtime = parseHours(getField(row, ['Overtime Hour']));
                if (overtime > 0) {
                    emp['lembur'] += overtime;
                    if (isHoliday) emp['lemburLibur'] += overtime;
                    else emp['lemburBiasa'] += overtime;
                }
            });

            // Convert to array dan set nomor urut
            return Object.values(grouped).map((emp, idx) => {
                emp['no'] = idx + 1;
                // Round decimal values
                ['lateInHours', 'lembur', 'lemburBiasa', 'lemburLibur'].forEach(k => {
                    emp[k] = Math.round(emp[k] * 100) / 100;
                });
                return emp;
            });
        }

        function renderPreview(data) {
            const thead = document.querySelector('#previewTable thead');
            const tbody = document.querySelector('#previewTable tbody');
            
            // Render ALL 51 columns
            thead.innerHTML = '<tr>' + COLUMN_HEADERS.map(h => `<th>${h}</th>`).join('') + '</tr>';
            
            tbody.innerHTML = data.map(row => {
                const cells = DATA_KEYS.map(key => {
                    const val = row[key];
                    return `<td>${val !== undefined && val !== '' ? val : 0}</td>`;
                });
                return '<tr>' + cells.join('') + '</tr>';
            }).join('');
        }

        downloadBtn.addEventListener('click', async () => {
            if (!summaryData) return;

            // Create workbook with ExcelJS
            const workbook = new ExcelJS.Workbook();
            workbook.creator = 'Divisi Human Capital - Bank Sulselbar';
            workbook.created = new Date();
            
            const worksheet = workbook.addWorksheet('Sheet1');

            // Add header row manually (untuk handle duplikat)
            const headerRow = worksheet.addRow(COLUMN_HEADERS);

            // Set column widths
            COLUMN_WIDTHS.forEach((width, idx) => {
                worksheet.getColumn(idx + 1).width = width;
            });

            // Add data rows - map internal keys ke posisi kolom
            summaryData.forEach(emp => {
                const rowData = DATA_KEYS.map(key => {
                    const val = emp[key];
                    return val !== undefined ? val : 0;
                });
                worksheet.addRow(rowData);
            });

            // Border style
            const borderStyle = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };

            // Style header row (row 1)
            worksheet.getRow(1).eachCell((cell) => {
                cell.font = { bold: true, size: 11 };
                cell.alignment = { horizontal: 'center', vertical: 'center' };
                cell.border = borderStyle;
            });

            // Style data rows
            for (let i = 2; i <= summaryData.length + 1; i++) {
                worksheet.getRow(i).eachCell((cell) => {
                    cell.border = borderStyle;
                });
            }

            // Generate file
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            
            const now = new Date();
            const filename = `Attendance_Summary_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}.xlsx`;
            
            saveAs(blob, filename);
        });
    </script>
</body>
</html>
